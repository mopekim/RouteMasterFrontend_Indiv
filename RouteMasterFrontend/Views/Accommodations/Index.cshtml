@using RouteMasterFrontend.Models.Dto;
@model FilterDTO
@{
    var account = Context.Request.HttpContext.User.Identity.Name;
}
@section Styles{
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <script src="https://kit.fontawesome.com/ad2e9fef09.js" crossorigin="anonymous"></script>
    <link href="~/hotel-datepicker-main/dist/css/hotel-datepicker.css" rel="stylesheet" /><!-- Optional -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDr_zVippBk_-dJNEGc5yK8PtX-xE5qZ-w&libraries=&v=weekly" defer></script> 
     <script src="../js/sweetalert2.all.min.js"></script>
    <link href="~/css/Comments_Accommodation.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css">

    <style>
        .currentPage {
            background-color: lightgray;
        }

        .w-33 {
            width: 33.33333333%;
        }

        .h-33 {
            height: 33.33333333%
        }

        .main-left {
            width: 24% !important;
        }

        .main-right {
            width: 74% !important;
            padding: 0 !important;
        }

        .modal-xl {
            max-width: 90% !important;
            width: 90%;
            height: 90%;
        }

        .modal-container {
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        .product-info { /*內含left , right 二個div*/
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: end;
            align-items: start;
        }

            .product-info .left {
                width: 662px;
            }

            .product-info .right {
                width: 58%;
                padding: 10px;
                margin-left: auto;
                overflow: auto;
            }

        .productPhoto {
            object-fit: cover; /*contain 符合指定的寬高比例*/
            width: 100%;
        }

        .product-info .images {
            width: 100%;
            height: 64px;
        }

        .product-info .imageList {
            list-style: none; /* 不顯示項目符號 */
            width: 100%;
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
        }

            .product-info .imageList li {
                margin: 1px;
            }

                .product-info .imageList li img {
                    width: 58px;
                    height: 58px;
                    cursor: pointer;
                    object-fit: cover;
                }

        .li-icon {
            width: 24px;
            height: 24px;
        }

        aside {
            position: sticky !important;
            height: 91.5vh;
            top: 80px;
        }

        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000;
            animation: spin 1s linear infinite;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <noscript>
        <style>
            .simplebar-content-wrapper {
                scrollbar-width: auto;
                -ms-overflow-style: auto;
            }

                .simplebar-content-wrapper::-webkit-scrollbar,
                .simplebar-hide-scrollbar::-webkit-scrollbar {
                    display: initial;
                    width: initial;
                    height: initial;
                }
        </style>
    </noscript>
    }

<div id="app" v-cloak>
    <div v-if="toggle">
        <h1>你是不是想找．．．</h1>
        <div id="RecommendMap" class="ratio ratio-16x9"></div>
        <input type="button" class="btn btn-outline-primary mt-2" data-id="index" id=`${product.id}` value="搜尋更多住所" @@click="toggleView" />
    </div>
    <div v-else>
        <div class="d-flex">
            <aside class="main-left border" style="padding:12px" data-simplebar>
                <div>
                    過透以下分類搜尋：
                </div>
                <div>
                    <h5 class="mb-2">房價預算(每晚)</h5>
                    <ul>
                        <li>
                            <div id="budget-values" class="mb-2">
                                <span id="min-budget">TWD：{{ minBudget }}</span> ～ <span id="max-budget">{{ maxBudget }}</span><span v-if="maxBudget == 10000">+</span>
                            </div>
                            <div id="budget-slider" class="mb-2" style="text-align:center; width:98%"></div>
                        </li>
                    </ul>
                </div><hr />
                <div>
                    <h5>住宿評等</h5>
                    <small>包含星級與其他類評等</small>
                    <ul>
                        <li v-for="(grade, index) in filterDto.grades">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="grades" v-bind:id="'grade' + index" v-model="selectedGrades" v-bind:value="grade" @@change="showPages">
                                <label class="form-check-label" v-bind:for="'grade' + index"> {{grade}} 星級</label>
                            </div>
                        </li>
                    </ul>
                </div><hr />
                <div>
                    <h5>住宿類型</h5>
                    <ul>
                        <li v-for="(aCategory,index) in filterDto.acommodationCategories">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="aCategory" v-bind:id="'aCategory' + index" v-model="selectedaCategories" v-bind:value="aCategory" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'aCategory' + index"> {{aCategory}}</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <hr />
                    <h5>評論分數</h5>
                    <ul>
                        <li v-for="(score, index) in filterDto.commentSorce">
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="score" v-bind:id="'score' + index" v-model="selectedScore" v-bind:value="score" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'score' + index"> {{score}} 分以上</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <hr />
                    <h5>設施與服務</h5>
                    <ul>
                        <li v-for="(sCategory, index) in filterDto.serviceInfoes">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="sCategory" v-bind:id="'sCategory' + index" v-model="selectedsCategories" v-bind:value="sCategory.name" @@change="toggleSInfos(index)">
                                <label class="form-check-label" v-bind:for="'sCategory' + index">{{ sCategory.name }}</label>
                                <div class="ms-4" v-for="(sInfo, sIndex) in sCategory.infos">
                                    <input type="checkbox" class="form-check-input" name="sInfo" v-bind:id="'sInfo' + index + '-' + sIndex" v-model="selectedServiceInfos" v-bind:value="sInfo" @@change="showPages">
                                    <label class="form-check-label" v-bind:for="'sInfo' + index + '-' + sIndex">{{ sInfo }}</label>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <hr />
                    <h5>縣市</h5>
                    <ul>
                        <li v-for="(region, index) in filterDto.regions">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="region" v-bind:id="'region' + index" v-model="selectedaRegions" v-bind:value="region" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'region' + index"> {{region}} </label>
                            </div>
                        </li>
                    </ul>
                </div>
            </aside>
            <div class="main-right ms-auto">
                <nav class="d-flex row position-sticky bg-white w-100 ms-0" style=" top:80px; z-index:10; padding-bottom:12px">
                    <div class="col-3 ps-0">
                        <input type="search" v-model="keyword" class="form-control" placeholder="搜尋關鍵字" @@change="showPages">
                    </div>
                    <div class="col-2"><button class="form-control" @@click="clearFilter">清除篩選</button></div>
                    <div class="d-flex col-3 p-0 justify-content-end">
                        <label for="sort" class="form-label mb-0 me-2 d-flex align-items-center">排序：</label>
                        <select class="form-select w-50" v-model="sort" aria-label="Small select example" @@change="showPages">
                            <option value="0">請選擇</option>
                            <option value="1">依星級高到低</option>
                            <option value="2">依星級低到高</option>
                            <option value="3">依評論高到低</option>
                            <option value="4">依房價低到高</option>
                            <option value="5">依房價高到低</option>
                        </select>
                    </div>
                    <div class="d-flex col-4 p-0 justify-content-end">
                        <label for="page" class="form-label mb-0 me-2 d-flex align-items-center">每頁顯示</label>
                        <select class="form-select w-33" v-model="pageSize" aria-label="Small select example" @@change="showPages">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="5">&#8734;</option>
                        </select>
                        <label for="page" class="form-label mb-0 ms-2 d-flex align-items-center">筆</label>
                    </div>
                </nav>
                <table id="imgTable" class="w-100">
                    <thead>
                        <tr>
                            <th>

                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(product, index) in products" :key="product.id">
                            <td>
                                <div class="row">
                                    <div class="col">
                                        <div class="card mb-3">
                                            <div class="row g-0 ">
                                                <div class="col-5">
                                                    <div class="ratio ratio-4x3">
                                                        <img class="card-img card-img-left h-100 w-100" v-bind:src="product.image" style="object-fit:cover" alt="尚未建立住所照片" />
                                                    </div>
                                                </div>
                                                <div class="col-7">
                                                    <div class="card-body w-100 h-100 d-flex flex-column">
                                                        <div class="d-flex align-items-center mb-1">
                                                            <h3 class="card-title m-0 me-2">
                                                                {{product.name}}
                                                            </h3>
                                                            <i v-for="grade in product.grade" class="fa-solid fa-star fa-flip" style="color: #ffc800;"></i>
                                                            <p class="ms-auto fs-6">{{product.comment}}筆評論</p>
                                                            <span class="score-div bg-primary text-white d-flex justify-content-center align-items-center rounded-2 ms-2" style="width: 40px; height: 40px; letter-spacing:1px">{{product.score}}</span>
                                                        </div>
                                                        <h5 class="card-text">
                                                            <small class="text-muted">
                                                                {{product.address}}
                                                            </small>
                                                        </h5>
                                                        <div class="mt-auto d-flex">
                                                            <h4 class="mt-auto me-auto">房價最低(每晚)： {{product.price}} TWD 起</h4>
                                                            <input type="button" class="btn btn-outline-primary" v-bind:data-id="index" v-bind:id=`${product.id}` data-bs-toggle="modal" data-bs-target="#exampleModal" value="住所資訊" @@click="showModal(product.id)" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <div v-if="isLoading" class="loading-indicator">
                            <div class="spinner"></div>
                            內容加載中...
                        </div>
                    </tbody>
                </table>
            </div>
        </div>
        <hr />
        <nav v-if="pageSize >5" aria-label="Page navigation example">
            <ul class="pagination justify-content-center flex-wrap mt-2 mb-4">
                <li v-if="hasPrevious" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(1)">&lt;&lt;</a>
                </li>
                <li v-if="hasPrevious" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(thePage-1)">&lt;</a>
                </li>
                <li v-for="(value, index) in pageRange" :key="index" class="page-item">
                    <a v-if="value === ELLIPSIS" class="page-link d-flex align-items-center">{{ value }}</a>
                    <a v-else :class="{'page-link': true, 'currentPage': value === thePage}" href="#" @@click="clickHandler(value)">{{ value }}</a>
                </li>
                <li v-if="hasNext" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(thePage+1)">&gt;</a>
                </li>
                <li v-if="hasNext" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(totalPages)">&gt;&gt;</a>
                </li>
            </ul>
        </nav>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content h-100">
                <div class="modal-header pb-1 pe-3 flex-wrap">
                    <h1 class="modal-title fs-2 me-2" id="exampleModalLabel"><i class="fa-solid fa-hotel me-3"></i>{{accommodationIndex.name}}</h1>
                    <i v-for="grade in accommodationIndex.grade" class="fa-solid fa-star fa-flip" style="color: #ffc800;"></i>
                    <button type="button" class="btn-close me-1" data-bs-dismiss="modal" aria-label="Close"></button>
                    <div class="w-100 mt-2">
                        <div class="d-flex justify-content-between" style="width:14%">
                            <button class="form-control btn border-0 me-2 px-0" :class="{ 'btn-outline-success':!overview, ' btn-success':overview }" @@click="Overview(accommodationIndex.id)">總覽</button>
                            <button class="form-control btn border-0 px-0" :class="{ 'btn-outline-success':overview, ' btn-success':!overview }" @@click="ShowComments(accommodationIndex.id)">所有評論</button>
                            <span class="score-div bg-primary text-white d-flex justify-content-center align-items-center rounded-2 ms-2" style="width: 40px; height: 40px;min-width:40px; letter-spacing:1px">{{accommodationIndex.score}}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="modal-container h-100">
                        <div class="product-info h-100">
                            <div class="left h-100 mt-2 ms-2">
                                <div class="position-relative w-100">
                                    <div class="w-100 d-flex justify-content-center align-items-center" style="aspect-ratio: auto 1 / 1">
                                        <img v-if="accommodationImage" v-bind:src=`../AccommodationImages/${accommodationImage}` class="productPhoto position-fix" alt="">
                                    </div>
                                    <div class="images" data-simplebar>
                                        <ul class="imageList">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div v-show="overview" class="right h-100" data-simplebar>
                                <section class="mb-3">
                                    <p class="d-inline-flex gap-1 fs-5">
                                        <a class="" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </a>
                                        <span data-bs-toggle="tooltip" data-bs-title="Default tooltip">
                                            {{accommodationIndex.address}} -
                                        </span>
                                        <a class="" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                                            顯示地圖
                                        </a>
                                    </p>
                                    <div class="collapse" id="collapseExample">
                                        <div class="card card-body">
                                            <div id="map" class="ratio ratio-16x9"></div>
                                        </div>
                                    </div>
                                </section>
                                <section class="mb-3 pt-1">
                                    <p class="fs-5" v-html="accommodationDescription" @@click="toggleDescription">
                                    </p>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <h2 class="mb-2"><i class="fa-solid fa-comment-dots me-3"></i>住宿評論：</h2>
                                    <brief ref="childRef2"></brief>
                                    @* <button class="form-control btn border-0 px-0" :class="{ 'btn-outline-success':overview, ' btn-success':!overview }" @@click="ShowComments(accommodationIndex.id)">更多評論</button>*@
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <h2 class="mb-2"><i class="fa-solid fa-bed me-3"></i>客房供應：</h2>

                                    <table class="table table-hover table-success">
                                        <tbody>
                                            <tr v-for="(room, index) in accommodationIndex.rooms" v-bind:id="'rp' + index" class="row w-100 ms-0">
                                                <td class="col-2 d-flex align-items-center" id="rn">
                                                    {{room.name}}
                                                </td>
                                                <td class="d-flex col-10">
                                                    <button class="btn btn-warning me-3" data-bs-toggle="collapse" v-bind:id=`collapseBtn${room.id}` v-bind:data-bs-target=`#collapseDatePicker${index}` role="button" aria-expanded="false" aria-controls="collapseDatePicker" @@click.once="createdp(room.id)">訂房</button>
                                                    <div class="collapse" v-bind:id=`collapseDatePicker${index}`>
                                                        <div class="d-flex align-items-center">
                                                            <label v-bind:for=`dp-${room.id}`>日期：</label>
                                                            <input v-bind:id=`dp-${room.id}` type="text" class="form-control dp me-2" autocomplete="off" placeholder="請選擇日期" readonly style="background:white;width:236px;box-sizing:border-box" />
                                                            <div v-bind:id=`ptInput-${room.id}` style="display:none">
                                                                <div class="d-flex align-items-center">
                                                                    <label v-bind:for=`pq-${room.id}` >數量：</label>
                                                                    <input v-bind:id=`pq-${room.id}` type="number" min="1" value="1" size="2" class="form-control pq me-2" style="width:63px; box-sizing:border-box" />
                                                                    <label v-bind:for=`tp-${room.id}`>總價：</label>
                                                                    <input v-bind:id=`tp-${room.id}` type="text" value="999999" class="form-control me-3" style="background:white;width:87px; box-sizing:border-box" readonly />
                                                                    <button v-if="!toggle" class="btn btn-primary" @@click="addCart(room.id)">加入購物車</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr v-if="toggle" id="addPlanBtn" style="display:none">
                                                <td>
                                                    <button class="form-control btn btn-primary" @@click="addCart()">加入排程</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <h2 class="mb-2 "><i class="fa-solid fa-award me-3"></i>設施與服務：</h2>
                                    <div class="row d-flex w-100">
                                        <ul v-if="accommodationServiceCId.indexOf(1) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-van-shuttle"></i>交通與車輛相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 1})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(2) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-wifi"></i>網路與通訊相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 2})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(3) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-tv"></i>休閒與娛樂設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 3})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(5) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-handshake"></i>會議與商務設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 5})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(6) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-utensils"></i>餐飲相關設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 6})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(7) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-regular fa-credit-card"></i>金融與支付相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 7})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(8) !== -1" class="col-3 mb-4 pe-0">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-circle-info"></i>其他
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 8})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                    </div>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <img src="https://static.thenounproject.com/png/2392202-200.png" style="width:24px;height:24px" /> 最早CheckIn時間：{{accommodationIndex.checkIn}}
                                    <img src="https://static.thenounproject.com/png/2392153-200.png" style="width:24px;height:24px" /> 最晚CheckOut時間：{{accommodationIndex.checkOut}}
                                </section>
                            </div>
                            <div v-show="!overview" class="right h-100">
                                <dec ref="childRef1"></dec>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="https://unpkg.com/vue@3.2.36/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <script src="~/fecha-4.2.1/fecha-4.2.1/lib/fecha.js"></script>
    <script src="~/hotel-datepicker-main/dist/js/hotel-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
            integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/Comments_AccommodationPartial.js" asp-append-version="true"></script>
    <script src="~/js/Comments_AccommodationBrief.js" asp-append-version="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
    <script>
        var vueApp = {
            data() {
                return {
                    //Country:"",
                    keyword: [],
                    products: [],
                    totalPages: 1,
                    thePage: 1,
                    pageSize: 10,
                    filterDto: @Html.Raw(Json.Serialize(Model)),
                    selectedGrades: [],
                    selectedaCategories: [],
                    selectedScore: Number,
                    selectedsCategories: [],
                    selectedServiceInfos: [],
                    selectedaRegions: [],
                    accommodationIndex: {},
                    accommodationImage: "",
                    accommodationDescription: "",
                    cartProducts: [],
                    alertContent: [],
                    accommodationServiceCId: [],
                    cartItems: [],
                    map: null,
                    toggle: false,
                    overview: true,
                    isLoading: false,
                    sort:0,
                    minBudget: @Html.Raw(Json.Serialize(Model.MinBudget)),
                    maxBudget: @Html.Raw(Json.Serialize(Model.MaxBudget)),
                }
            },
            created: function () {
                const param = window.location.search
                if (param.includes('?Recommend=') && param.length <= 13) {
                    this.toggle = true;
                }
            },
            mounted: function () {
                let _this = this;
                if (!_this.toggle) {
                    _this.initBudgetSlider();
                    _this.loadProducts();
                }
            },
            computed: {
                hasPrevious() {
                    return this.thePage > 1;
                },
                hasNext() {
                    return this.thePage < this.totalPages;
                },
                pageRange() {
                    const maxPagesToShow = 5; // Adjust the maximum number of pages to show in the pagination
                    const middlePage = Math.floor(maxPagesToShow / 2);
                    const startPage = Math.max(this.thePage - middlePage, 1);
                    const endPage = Math.min(startPage + maxPagesToShow - 1, this.totalPages);
                    const pages = [];
                    for (let i = startPage; i <= endPage; i++) {
                        pages.push(i);
                    }
                    if (startPage > 1) {
                        pages.unshift("...");
                    }
                    if (endPage < this.totalPages) {
                        pages.push("...");
                    }
                    return pages;
                },
                ELLIPSIS() {
                    return "...";
                },
            },
            methods: {
                initMap: function () {
                    const p = this.accommodationIndex;
                    const location = { lat: p.positionY, lng: p.positionX };
                    this.map = new google.maps.Map(document.getElementById("map"), {
                        // 中心點位置
                        center: location,
                        zoom: 14, // 地圖縮放比例 (0-20)
                        streetViewControl: true, // 是否顯示右下角街景小人
                        mapTypeControl: true // 使用者能否切換地圖樣式：一般、衛星圖等
                    });

                    let marker = new google.maps.Marker({
                        position: location,
                        map: this.map,
                        title: p.name
                    });
                    let starsHtml = "";
                    // info window
                    let infowindow = new google.maps.InfoWindow({
                        content: `
                <div class="card" style="width: 280px;">
                    <div class="row g-0">
                        <div class="col-md-6">
                            <div class="ratio ratio-4x3">
                                <img src="${p.image}" class="img-fluid rounded-start h-100 w-100" style="object-fit:cover" alt="...">
                            </div>
                        </div>
                        <div class="col-md-6">
                                <div class="card-body h-100 p-2 d-flex flex-column justify-content-center">
                                <h4 class="card-title">${p.name}</h4>
                                <div class=" d-flex align-items-center">
                                ${
                            // 使用內嵌表達式生成星星圖示
                            (() => {
                                for (let i = 1; i <= p.grade; i++) {
                                    starsHtml += `<i class="fa-solid fa-star fa-flip fs-5" style="color: #ffc800;"></i>`;
                                }
                                return starsHtml;
                            })()
                            }
                                    </div>
                                        <p class="card-text d-flex align-items-end mt-2"><span class="score-div bg-primary text-white d-flex justify-content-center align-items-center rounded-2 me-2" style="width: 40px; height: 40px; letter-spacing:1px">${p.score}</span>${p.comments}筆評論</p>
                            </div>
                        </div>
                    </div>
                </div>
            ` // 支援html
                    });
                    infowindow.open(this.map, marker);

                    // 監聽 marker click 事件
                    marker.addListener('click', e => {
                        infowindow.open(this.map, marker);
                    });

                    this.map.setOptions({
                        styles: [
                            {
                                featureType: 'poi.business',
                                stylers: [{
                                    visibility: 'off'
                                }]
                            }
                        ]
                    });
                    //this.calculateDrivingTime(location, [{ lat: this.products[1].positionY, lng: this.products[1].positionX }, { lat: this.products[2].positionY, lng: this.products[2].positionX }])
                },
                calculateDrivingTime: function calculateDrivingTimes(originLatLng, destinationLatLngs) {
                    const bounds = new google.maps.LatLngBounds();
                    const markersArray = [];

                    // initialize services
                    const geocoder = new google.maps.Geocoder();
                    const service = new google.maps.DistanceMatrixService();
                    // build request
                    const origin1 = originLatLng/* { lat: 55.93, lng: -3.118 } */;
                    const origin2 = "Greenwich, England";
                    const destination = destinationLatLngs/* { lat: 50.087, lng: 14.421 } */;
                    const request = {
                        origins: [origin1, origin2],
                        destinations: destination,
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.METRIC,
                        avoidHighways: false,
                        avoidTolls: false,
                    };

                    // get distance matrix response
                    service.getDistanceMatrix(request).then((response) => {
                        let r = response.rows[0].elements[0]
                        console.log(r);
                        console.log(r.distance.value); // 距離 公尺
                        console.log(r.duration.value); // 時間 秒

                        const originList = response.originAddresses;
                        const destinationList = response.destinationAddresses;
                    });
                },
                loadProducts: async function (infinity) {
                    let _this = this;
                    let request = {
                        minBudget: _this.minBudget,
                        maxBudget: _this.maxBudget,
                        keyword: /^\s*$/.test(_this.keyword) || _this.keyword === null || _this.keyword === undefined ? null : _this.keyword.split(" "),
                        page: _this.thePage,
                        pageSize: _this.pageSize,
                        grades: _this.selectedGrades,
                        aCategory: _this.selectedaCategories,
                        score: _this.selectedScore,
                        sCategory: _this.selectedServiceInfos,
                        regions: _this.selectedaRegions,
                        sortBy : _this.sort
                    };
                    const response = await fetch(`https://localhost:7251/api/Accommodations`, {
                        method: "Post",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(request)
                    });
                    const datas = await response.json();
                    console.log(datas);
                    if (_this.pageSize < 10) {
                        window.addEventListener("scroll", this.handleScroll);
                    }
                    else {
                        window.removeEventListener("scroll", this.handleScroll);
                    }
                    if (infinity) {

                        datas.items.map(function (data) {
                            _this.products.push(data)
                        })
                    }
                    else {
                        _this.products = (datas.items);
                    }
                    _this.totalPages = datas.totalPages;
                },
                showPages: function () {
                    let _this = this;
                    _this.thePage = 1;
                    _this.loadProducts();
                },
                loadMoreContent() {
                    if (this.thePage < this.totalPages) {
                        this.isLoading = true;
                        this.thePage++; // 增加頁面號碼
                        this.loadProducts(true).then(() => {
                            // Add a delay using setTimeout
                            setTimeout(() => {
                                this.isLoading = false; // Hide loading indicator after delay
                            }, 300); // 300 milliseconds (0.3 seconds)
                        });
                    }
                },
                handleScroll() {
                    const windowHeight = window.innerHeight;
                    const contentHeight = document.documentElement.scrollHeight;
                    const scrollPosition = window.scrollY;

                    if (contentHeight - windowHeight - scrollPosition < 200) {
                        this.loadMoreContent();
                    }
                },
                showModal: async function (id) {
                    let _this = this;
                    const exampleModal = document.getElementById('exampleModal')
                    if (exampleModal) {
                        const response = await fetch(`https://localhost:7251/api/Accommodations/${id}`)
                        const result = await response.json();
                        const p = _this.accommodationIndex = result;
                        console.log(p);

                        _this.accommodationImage = p.images[0] ? p.images[0].image : null;
                        _this.accommodationServiceCId = p.services.map(function (s) {
                            return s.serviceInfoCategoryId;
                        });

                        const showMoreText = "...顯示更多";
                        const showLessText = "...顯示更少";
                        const lines = _this.temp = p.description.split('\n');
                        // 如果行數超過 5 行，僅保留前 5 行
                        if (lines.length > 5) {
                            _this.accommodationDescription = lines.slice(0, 5).join('<br>') + `<small id='small' style='color: #999'>${showMoreText}</small>`;
                        } else {
                            _this.accommodationDescription = lines.join('<br>');
                        }

                        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
                        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

                        // 可改寫VUE
                        const modalImg = exampleModal.querySelector('.product-info ul');
                        modalImg.innerHTML = "";
                        p.images.map(function (p) {
                            const ce = document.createElement('li');
                            ce.innerHTML = `<img src="../AccommodationImages/${p.image}"/>`;
                            modalImg.append(ce);
                        });

                        $('.product-info ul li img').click(function () {
                            var imgSrc = $(this).attr('src');
                            _this.accommodationImage = imgSrc;
                        })
                        _this.$refs.childRef2.commentBrief(p.id);


                        _this.initMap(id);
                    }
                },
                clickHandler: function (value) {
                    let _this = this;
                    _this.thePage = value;
                    _this.loadProducts();
                },
                toggleSInfos: function (index) {
                    const sCategory = this.filterDto.serviceInfoes[index];
                    const sInfos = sCategory.infos;
                    if (this.selectedsCategories.includes(sCategory.name)) {
                        this.selectedServiceInfos = [...new Set([...this.selectedServiceInfos, ...sInfos])];
                    } else {
                        this.selectedServiceInfos = this.selectedServiceInfos.filter(item => !sInfos.includes(item));
                    }
                    this.showPages();
                },
                addCart: async function (roomId) {
                    const _this = this;
                    if (_this.toggle) {
                        _this.cartProducts = []
                        _this.alertContent = []
                        for (let i = 0; document.querySelector(`#rp${i}`); i++) {
                            let selectedDays = $(`#rp${i} td[aria-label*="Selected"] .rp`).map(function () {
                                return Number($(this).text());
                            }).get();
                            selectedDays.pop();
                            console.log(selectedDays);
                            if (selectedDays.length > 0) {
                                let cartProduct = {
                                    roomProductId: selectedDays,
                                    quantity: Number($(`#rp${i} .pq`).val())
                                }
                                let content = {
                                    roomName: $(`#rp${i} #rn`).text(),
                                    date: $(`#rp${i} .dp`).val(),
                                    quantity: $(`#rp${i} .pq`).val()
                                }
                                _this.cartProducts.push(cartProduct);
                                _this.alertContent.push(content);
                            }
                        }

                        let request = {
                            accommodationName: _this.accommodationIndex.name,
                            cartProducts: _this.cartProducts
                        };
                        console.log(_this.alertContent)
                        Swal.fire({
                            title: `你選擇了：${request.accommodationName}
                                          確定將以下客房加入排程嗎?`,
                            text: `
                『
                    ${_this.alertContent.map(function (c) {
                                return `${c.roomName} : ${c.date} , ${c.quantity}間;`;
                            }).join('\n')}
                』`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: '好!',
                            cancelButtonText: '我再考慮一下~'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.opener.postMessage(JSON.stringify(request), window.location.origin);
                                Swal.fire(
                                    '恭喜!',
                                    '已成功加入排程!',
                                    'success'
                                )
                                window.close();
                            }
                        })
                        //                        alert(`你選擇了：${request.accommodationName}
                        //『
                        //    ${_this.alertContent.map(function(c){
                        //        return `${c.roomName} : ${c.date} , ${c.quantity}間;`;
                        //    }).join('\n')}
                        //』`);
                    }
                    else {

                        let selectedDays = $(`#datepicker-dp-${roomId} .datepicker__month-day--selected .rp`).map(function () {
                            return Number($(this).text());
                        }).get();
                        selectedDays.pop();

                        _this.cartProducts = selectedDays;

                        let request = {
                            roomProductId: _this.cartProducts,
                            quantity: Number($(`#pq-${roomId}`).val())
                        };

                        await fetch(`https://localhost:7145/Carts/AddAccommodation2Cart`, {
                            method: "Post",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(request)
                        }).then((response) => {
                            response.text().then((data) => {
                                $('#Cart').html(data);
                                alert("已成功加入購物車");
                            })
                        });
                    }
                },
                toggleDescription: function () {
                    const showMoreText = "...顯示更多";
                    const showLessText = "...顯示更少";
                    const lines = this.temp;
                    const s = $('#small');
                    if (s[0]) {
                        if (!this.showFullDescription) {
                            this.accommodationDescription = lines.join("<br>") + `<small id="small" style="color: #999">${showLessText}</small>`;

                        } else {
                            this.accommodationDescription = lines.slice(0, 5).join('<br>') + `<small id="small" style="color: #999">${showMoreText}</small>`;
                        }
                        this.showFullDescription = !this.showFullDescription;
                    }
                },
                createdp: async function (id) {
                    const _this = this;
                    "use strict";
                    const response = await fetch(`https://localhost:7251/api/RoomProducts/${id}`);
                    const datas = await response.json();
                    const rps = datas.items;
                    const disabledDates = datas.disableDate;
                    const dpInput = document.getElementById(`dp-${id}`);
                    const pqInput = $(`#pq-${id}`);
                    const ptInput = $(`#tp-${id}`);
                    //let maxQuantity;

                    var hdpkr = new HotelDatepicker(dpInput, {
                        clearButton: true,
                        topbarPosition: 'bottom',
                        selectForward: true,
                        disabledDates: disabledDates,
                        enableCheckout: true,
                        extraDayText: function (date, attributes) {
                            for (var i = 0; i < rps.length; i++) {
                                if (date === fecha.format(new Date(rps[i].date), "YYYY-MM-DD") && attributes.class.includes("datepicker__month-day--visibleMonth")) {
                                    return `<br>$${rps[i].newPrice}<div class="d-none rp">${rps[i].id}</div>`;
                                }
                            }
                        },
                        endDate: rps[rps.length - 1].date
                    });

                    dpInput.addEventListener('afterClose', function () {
                        const value = this.value;
                        const pattern = /^(\d{4}-\d{2}-\d{2}) - (\d{4}-\d{2}-\d{2})$/;
                        const match = pattern.exec(value);
                        const addPlanBtn = $('#addPlanBtn');
                        let total;

                        if (match) {
                            const startDate = new Date(match[1]);
                            const endDate = new Date(match[2]);

                            if (!isNaN(new Date(startDate)) && !isNaN(new Date(endDate))) {
                                total = rps.reduce((acc, item) => {
                                    const itemDate = new Date(item.date);
                                    if (itemDate >= startDate && itemDate < endDate) {
                                        acc.sum += item.newPrice;
                                        acc.quantity = Math.min(acc.quantity, item.quantity)
                                    }
                                    return acc;
                                }, { sum: 0, quantity: Infinity });

                                pqInput.attr("max", total.quantity).val(1);
                                ptInput.val(total.sum);

                                $(`#ptInput-${id}`).show();
                                if (addPlanBtn) { addPlanBtn.show(); }

                                pqInput.off('change');
                                pqInput.on('change', function () {
                                    if (pqInput.val() > total.quantity) {
                                        pqInput.val(total.quantity);
                                    } else if (pqInput.val() < 1) {
                                        pqInput.val(1);
                                    }
                                    ptInput.val(total.sum * pqInput.val());
                                })
                            }
                            else {
                                alert("請使用日期選取!");
                            }
                        }
                    }, false);
                },
                RecommendAccommodation: async function (x, y, name) {
                    // x = 121.12;
                    // y = 22.79;

                    const location = { lat: y, lng: x };
                    let _this = this;
                    let modal = new bootstrap.Modal(document.getElementById("exampleModal"));

                    this.map = new google.maps.Map(document.getElementById("RecommendMap"), {
                        // 中心點位置
                        center: location,
                        zoom: 13, // 地圖縮放比例 (0-20)
                        streetViewControl: true, // 是否顯示右下角街景小人
                        mapTypeControl: true // 使用者能否切換地圖樣式：一般、衛星圖等
                    });
                    const N = window.location.search.replace('?Recommend=', '');
                    const topN = N > 0 ? N : 10;

                    const response = await fetch(`https://localhost:7251/api/Accommodations?lngX=${x}&latY=${y}&topN=${topN}`)
                    const result = await response.json();

                    _this.products = result;

                    result.forEach(r => {
                        let latLng = new google.maps.LatLng(r.positionY, r.positionX);

                        let marker = new google.maps.Marker({
                            position: latLng,
                            //icon: "https://akveo.github.io/eva-icons/outline/png/128/gift-outline.png", // 自定義圖標，google也有提供5個預設的圖標，參考下方*1
                            map: _this.map,
                            animation: google.maps.Animation.BOUNCE, // DROP掉下來、BOUNCE一直彈跳
                            draggable: false // true、false可否拖拉
                        });

                        let distanceOutput = '';
                        if (r.distance >= 1) {
                            distanceOutput = r.distance.toFixed(1) + '公里';
                        } else {
                            distanceOutput = (r.distance * 1000) + '公尺';
                            const distanceLevel = Math.floor(r.distance * 1000 / 50);
                            distanceOutput = (distanceLevel * 50) + '公尺';
                        }

                        let infowindow = new google.maps.InfoWindow({
                            content: `
                                                    <div class="card" style="width: 410px;">
                                                      <div class="row g-0">
                                                        <div class="col-md-6">
                                                            <div class="ratio ratio-4x3">
                                                              <img src="${r.image}" class="img-fluid rounded-start h-100 w-100" style="object-fit:cover" alt="...">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="card-body h-100 pb-0 d-flex flex-column justify-content-center">
                                                            <h5 class="card-title h-33">${r.name}<i v-for="grade in ${r.grade}" class="fa-solid fa-star fa-flip" style="color: #ffc800;"></i></h5>
                                                            <p class="card-text d-flex align-items-end h-33"><span class="score-div bg-primary text-white d-flex justify-content-center align-items-center rounded-2 me-2" style="width: 40px; height: 40px; letter-spacing:1px">${r.score}</span>${r.comment}筆評論</p>
                                                            <p class="card-text d-flex justify-content-end align-items-end h-33"><small class="ms-auto text-body-secondary">距離你的位置： ${distanceOutput} </small></p>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    </div>
                                                    ` // 支援html
                        });

                        marker.addListener('mouseover', e => {
                            infowindow.open(_this.map, marker);
                        });

                        marker.addListener('mouseout', e => {
                            infowindow.close(_this.map, marker);
                        });

                        marker.addListener('click', e => {
                            _this.showModal(r.id)
                            modal.show();
                        });

                    });

                    let myLocationIcon = {
                        url: "../AccommodationImages/2cf8eafd8d3bc1a7fcbef8286fd92c08_512_512.png", // 替换为你的自定义图标的URL
                        scaledSize: new google.maps.Size(40, 40), // 自定义图标的大小
                    };

                    let markerCenter = new google.maps.Marker({
                        position: location,
                        icon: myLocationIcon, // 自定義圖標，google也有提供5個預設的圖標，參考下方*1
                        map: _this.map,
                        animation: google.maps.Animation.DROP, // DROP掉下來、BOUNCE一直彈跳
                        draggable: false // true、false可否拖拉
                    });


                    let centerInfowindow = new google.maps.InfoWindow({
                        content: `你的位置` // 支援html
                    });

                    markerCenter.addListener('click', e => {
                        centerInfowindow.open(_this.map, markerCenter);
                    });

                    centerInfowindow.open(_this.map, markerCenter);

                    this.map.setOptions({
                        styles: [
                            {
                                featureType: 'poi.business',
                                stylers: [{
                                    visibility: 'off'
                                }]
                            }
                        ]
                    });

                    alert("已幫你挑選10間精選住所")

                },
                Overview: function (id) {
                    this.overview = true;
                    this.showModal(id);
                },
                ShowComments: function (id) {
                    this.overview = false;
                    console.log(id);
                    var identity = "@account" ? "@account" : "";
                    this.$refs.childRef1.commentDisplay(id, identity);
                },
                toggleView: function () {
                    this.toggle = false;
                    this.loadProducts();
                    this.initBudgetSlider();
                },
                initBudgetSlider: function () {
                    let _this = this;
                    const budgetSlider = document.getElementById('budget-slider');

                    noUiSlider.create(budgetSlider, {
                        start: [_this.minBudget, _this.maxBudget],
                        connect: true,
                        range: {
                            'min': _this.minBudget,
                            'max': _this.maxBudget,
                        },
                        step: 100, // 设置步长为 100
                        format: {
                            to: value => parseInt(value),
                            from: value => parseInt(value),
                        },
                    });

                    budgetSlider.noUiSlider.on('update', (values, handle) => {
                        _this.minBudget = values[0];
                        _this.maxBudget = values[1];
                        _this.showPages();
                    });
                },
                clearFilter:function(){
                    this.minBudget = @Html.Raw(Json.Serialize(Model.MinBudget));
                    this.maxBudget = @Html.Raw(Json.Serialize(Model.MaxBudget));
                    this.selectedGrades = [];
                    this.selectedaCategories = [];
                    this.selectedScore = 0;
                    this.selectedsCategories = [];
                    this.selectedaRegions = [];
                    this.showPages();
                },
            },
            components: {
                dec,
                brief
            }
        }
        var app = Vue.createApp(vueApp).mount("#app");
                        //app.component('brief',childRef2);
                        //app.component('dec', childRef1);
    </script>
}